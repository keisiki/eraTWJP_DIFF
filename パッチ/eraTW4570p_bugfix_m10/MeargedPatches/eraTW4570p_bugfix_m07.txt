2017/12/12
eraTW4.570proto用バグ修正7


◆説明
・>>100,101の構文ミス修正
・>>110、睡眠姦中にMASTERがおっきしにくいバグの修正
・>>111、周回時に一部のおぱんつが引き継げないバグの修正
・演奏コマンドのバグ修正と機能強化（弱化？）
・その他、出来る範囲でのリファクタリング



◆対象環境
eraTW4.570protoのバニラ環境、もしくは以下のパッチのみを適用している場合には
そのまま上書きが可能です（変更内容をマージしてあります）
これ以外のパッチとの相性は不明

・[eraT0010318]eraTW4.570proto用バグ修正
・[eraT0010320]eraTW4.570proto用乳首吸い継続バグ修正+α
・[eraT0010324]eraTW4.570proto用バグ修正2＋α
・[eraT0010325]eraTW4.570proto用美鈴csv修正+一括処理挙動変更
・[eraT0010326]eraTW4.570proto用バグ修正3
・[eraT0010327]eraTW4.570proto用バグ修正4
・[eraT0010328]eraTW4.570proto用美鈴csv修正+一括処理挙動変更v2
・[eraT0010329]eraTW4.570proto用バグ修正5
・[eraT0010331]eraTW4.570proto用バグ修正6

※　[eraT0010325]と[era0010328]について
引き続きめーりんのcsv修正だけもらってます
個人的にこっちの方が好みってだけです
（責任は持ちませんが）当パッチ→[era0010328]なら問題なさそう？？？



◆変更内容
・>>100,101の構文ミス修正
「SIF !HOGE == 1」や「SIF !HOGE == 2」といった記述を修正
とりあえず「![A-Za-z][^|\&]* ==」で引っかかったヤツは潰したが
一箇所だけ、関数@K17_RT_FGについては詳しい内容がよくわからずにそのままの状態
変にいじりたくなかった
口上系も直したけどライセンス上の問題はないはず

・ @GET_TARGETNUM()のリファクタリング
使われていなかったARGの廃止
FOR-NEXTでの取得からFINDELEMENTでの取得に変更して効率化

・@COM350のリファクタリング
記述がとっちらかっていたので整えた

・>>110、睡眠姦中にMASTERがおっきしにくいバグの修正
そも、睡眠姦でMASTERのうふふが0なのが正しいのか？とかそういう問題もあるけど
とりあえずこれで通すことにした

・>>111、周回時に一部のおぱんつが引き継げないバグの修正
パンツ保存の範囲指定外になってたのでこれで動くはず

・@ANOTHERTARGET_TALKのリファクタリング
抽選処理が冗長だったので簡略化

・古い@TARGETSET_CHACKを消した
コメントアウトしてたしもう使わんでしょう

・TARGET対象のFOR-NEXT処理の見直し
「TARGET:LOCAL」でGREPを行い、全体を見なおした
	FOR LOCAL, 0, CHARANUM
↑こういうのをできるだけ↓こうした
	FOR LOCAL, 1, GET_CHARANUM() + 1
ループ中に中断処理があればいいが
	SIF TARGET <= 0
		BREAK
大半の処理で特に意味もなく全キャラループでCONTINUEで済ませてたのは無駄に重くなるはず
CHARANUMが130程度に対してTARGETは大抵10キャラとか
実感は出来ないだろうが軽くなるといいな


また、見直しの際にCOM416などでバグを発見したためこれを修正した

具体的にはこのように
FOR LOCAL,1,CHARANUM
	TCVAR:LOCAL:演奏参加 = 0
	SIF TARGET:LOCAL <= 0
		CONTINUE
	SIF !SHIRAHU(TARGET:LOCAL)
		CONTINUE
	TARGET = TARGET:LOCAL
	CALL COM416_1
	SIF TCVAR:LOCAL:演奏参加
		参加人数 ++
NEXT
LOCALが「TARGETの要素を指すのか」「キャラの登録番号を指すのか」で混同していた部分を修正した

ちゅーか時折
	IF TCVAR:(TARGET:LOCAL):泥酔
こんな構文が見られたが
この場合は参照するTARGETがLOCAL依存になってしまうので適切な参照ができてない可能性がある
もちろんLOCALになにかを取得してるならこれでいいが大抵はバグってたっぽい

・ついでに演奏コマンドをいろいろ改造
１．失敗するとマイナスソースを取得（微量）
TARGET全員に反感が入り、演者には鬱屈も入る
あまりペナルティ大きくしてもなぁと思ったのでほんのりと

２．演奏失敗するとプラスソースが減少
失敗時は演奏規模が大きけりゃ大きいほど演奏効果が低くなる
減少するだけでなくなるわけではない

３．一部の演者の演奏でSOURCEに係数がつく
具体的には雷鼓さんとルナサ、メルランの3名

・個人的な更新
紅魔カジノヘルプのカリスマ解説にてカリスマ払い対応店舗の情報が古かったので更新
ナズーリンだけ個人名だしちゃったけど
わかりやすく、なおかつ収まりのいい表現が見つからなかったのだ
賑やかになってきてちょっと楽しいぞ

・Readmeの同包
そういえばマージしたパッチのリドミを同包していなかったので入れることにした
MeargedPatchesフォルダに放り込んだ



◆その他
・あなる処女喪失の状況って口上呼び出し時点でA性交経験ついてたっけ？？？
霊夢口上であなる処女喪失想定でＡ性交経験 == 0が前提の分岐を見た気がする

・>>13はまだ解決してない！
poseは弄る気になれない

・変えたい：索道駅のショートカットの挙動
索道駅がおでかけマップに対応しておらず、山頂/人里在住者しか利用できない
拠点マップでしか利用できない結果、利用できても片道切符になってしまうのがちょっと残念

・変えたい：COUNTER_SELECT.ERBあたりのリファクタリング
リドミを読んであの関数を使えばもっとさっくり書けるじゃんと思ったため検討

・eraTW幻想郷ガイドマップとか作るか？？？
どこに何があるのかある程度読めるようになってたほうが親切か？とか
そのままプレイヤーに丸投げだと気づかれない可能性があるのでは？とか
SHOPメニューで読めるようにしておく？
ざっくりネタ出し程度の覚え書き

システム的な説明とともにフレーバー的な文章も含むます
文体は適当だからつっこまないで
　博麗神社
　　・幻想郷の端に位置する神社だよ
　　・かの有名な博麗の巫女の本拠地だよ
　　・参拝するとちゃんとご利益があるよ
　　・神社の裏手の大樹には妖精さんたちが住んでるらしいよ
　　・神社の近くの夢幻遺跡では随時研究助手を募集してるよ
　命蓮寺
　　・妖怪たちがうじゃうじゃいるお寺だよ
　　　このお寺は人間と妖怪の共生を目指していて、ここの妖怪さんは基本的に人間にとって無害だよ
　　　困ったときは助けてくれるかもしれないよ
　　・ご住職は巨乳のお姉さんでご本尊様も綺麗なお姉さんだよ
　　・お隣の道場には聖徳太子さまがいらっしゃるよ
　　　命蓮寺のご住職とはライバル関係にあるらしいよ
　　・聖徳道場では仙人を目指して門下生たちが修行をしているよ
　人里
　　・幻想郷の心臓部、人間たちの居住区だよ
　　　身を守る能力のない非力な者でもとりあえず人里にいれば安全っぽいよ
　　・買い物するならここ
　　　貸本屋や園芸店、食料品店、酒屋さんに飲食店にと色々揃ってるよ
　　・幻想郷でも特に活気のある場所のひとつだよ
　　　人里の広場では週末にコンサートや人形劇などの催し物をしていることもあるよ
　　　宗教の勧誘してる人もいたりするから気をつけてね
　　・幻想郷に流れ着いたばかりの外来人は寺子屋で指導を受けるのもいいと思うよ
　　・最近、索道駅が設置されて妖怪の山山頂まで直通で行けるようになったよ
　霧の湖～紅魔館
　　・紅魔館は吸血鬼の住まう怪しい洋館だよ
　　・紅魔館にはカジノがあるよ
　　　カジノへは広間から入れるよ
　　　スロットやらブラックジャックやらが遊べるよ
　　・紅魔館の大図書館では蔵書を閲覧することもできるよ
　　・霧の湖のほとりには氷精やプリズンリバー三姉妹の住居があるよ
　迷いの竹林
　　・こんな名前だけどゲームシステム上、迷うということはないよ
　　・竹林の入り口あたりではときどき夜雀が屋台を出しているよ
　　・竹林の奥の方に永遠亭という病院があるよ
　　・永遠亭在住の妖怪兎からは各種の医薬品を買えたりするよ
　　・永遠亭では毎週木曜に薬の調剤を行っていてかなり忙しいらしいよ
　　・竹林を抜けた先、一面の花畑のさらに奥には夢幻館という館があるよ
　　・夢幻館の主はあまり人間には友好的ではないので気をつけたほうがいいよ
　魔法の森
　　・その名の通り、たくさんの魔法使いが住んでいる魔法の森だよ
　　・お店が沢山あるけど現時点ではシステム的にどうこうというものは少ないよ
　　・設定上は並の人間は入っただけで健康を害しかねない危険な場所だけどあなただから平気で歩けるよ
　三途の川～冥界
　　・あまり生者が入り浸るような地域ではないと思うよ
　　・現状、施設があんまりなくて寂しい場所だよ
　妖怪の山 (山麓)
　　・妖怪たちや豊穣の神さま、仙人さまなどが住んでいるよ
　　・名前の通り、少なくとも普通は人間が住む場所ではないよ
　　　あなたは普通の人間じゃないから住んでていいよ
　　・設定上は天狗の管理下にあって無断で入ると大変なことになりそうだけどあなただから平気で歩けるよ
　　・沢に住む河童が怪しげな道具を販売しているらしいよ
　妖怪の山 (山頂)
　　・素晴らしい景色で有名な場所だよ
　　・天狗たちと守矢神社の神々が住んでいるよ
　　・守矢神社では祭神の方々と直接会うことが出来るよ
　　・守矢神社ではくじ引きをすることができるよ
　　　一等や特賞はなんかすげーもんが貰えるらしいよ
　　・山の上からはさらに天人が暮らす天界に行くことが出来るよ
　　・最近、索道が完成して山頂に行きやすくなったよ
　地底
　　・幻想郷の中でも訳ありの妖怪たちが暮らす地域だよ
　　・鬼や嫌われ者の妖怪たちが広大な地下都市を築いているよ
　　・地底の旧都には繁華街が広がっていて、温泉まであるよ
　　・街の外れには地霊殿という巨大な洋館があるよ
　　・地霊殿には動物がたくさんいてとにかく掃除が大変だよ
　夢の世界～月
　　・地上よりも遥かに進んだ文明を持つ月の都に行くことが出来るよ
　　・月の民は地上の穢れに強い忌避感を持っているよ
　　・現状ではあまりこれといった施設はないよ



◆つくったひと：morph
・morphのつくった以外のところの扱いはつくったひとに聞いて下さい
・配布・改造・流用、好きにしてください
・でも、その際のサポートは自分でやってね

※　era＝R-18全般の常識的な取り扱いとして例えば以下のような事はやめて下さい

・未成年者がいっぱいいる場所で広める
・R-18以外のモノをメインに扱ってる場所で取り上げる
