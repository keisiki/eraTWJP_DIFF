eraTW4.821用 虹＆剛パッチ1.7

※注意事項
・必ずセーブデータのバックアップを取っておいてください
・影響範囲が非常に大きいので他のパッチとの併用はくれぐれもご注意ください（修正＆改良パッチ2.1は含まれています）
・導入後、必ず以下のファイルを削除してください
CSV＞Chara＞Chara143 行きずり
ERB＞キャラデータ＞Chara_data_143_モブ子
・導入後、必ずUPDATEしてください
（UPDATEするだけで新規住民が設定されるようになりました）

◆更新履歴
1.7
引力点によってエラーが出る問題を再度修正

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.6
※典口上は分離しました
※神奈子、典のキャラデータは最新版口上のものを含んでいます
竹林、山頂の移動バグを修正
女の子を物色で落ちるバグを修正
引力点によってエラーが出る問題を修正
遭遇位置が変化したとき連動が解けるのを修正
一緒にのんびりするの回復量を下方修正
休憩の回復量を上方修正
「修正＆改良パッチ2.1」の紫口上を同梱できていなかったので再度同梱

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.5
「TWカラーマップ改変2」を同梱しました。ありがとうございます。
「修正＆改良パッチ2.1」の紫口上を同梱
霊夢私室から押入れに行けなかったのを修正
　行こうとすると謎に時間を消費してました。
人里の範囲外が「参道の向こう」になっていたのを修正
星の仕事時間が活動時間から逸脱していたので仕事時間の方を修正
遭遇判定にデバッグ用の処理が残っていたのを修正
　デバッグ用の処理の方も修正
霧の湖で読書できていたのを修正

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.4
紅魔館と竹林マップで来訪者が入ってこれないのを修正
公共の場と進入不可の地点は汚れに上限が付くように
出現場所リストを修正
睡眠時間がエラーを吐く問題を再度修正

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.3
全員分のCHARAMOVE_DATAを修正＆改良＆設定
　CASE 2,5,6は不要になったので全て削除
　CASE 1は連動設定に
　CASE 3は生活時間補正設定に（現在はレミリアとフランのみに使われてます）
　主に新住居を与えられたキャラ、新地点が追加された分の設定
　一部キャラの条件連動や引力設定が追加されました
　夢美のキャラデータは夢美口上v1.9のものを含んでいます
一部キャラのCSVの行動に関わる部分を修正＆改変
　　　　　ドレミー：生活時間を口上による生活時間と表裏になるように改変
　レミリア、フラン：生活時間が変わるので変わっても大丈夫なように修正
　　　　ミスティア：響子との相性を追記
　　　　　　　天子：紫苑との相性を追記
　　　　　　　　雛：掃除係を付与
　　理香子、明羅、里香、ルイズ：自宅位置が異常だったので修正
起床時に各キャラの生活時間を設定するように
　CFLAG:生活時間補正を追加
　　起床、来訪、帰宅、就寝時間がそれぞれ補正値分ズレます
　　レミリア＆フラン、ドレミーの口上側による操作で使用
フランの仕事時間を生活時間がズレても大丈夫なように修正
キャラ移動処理を整理
　主にトイレの挙動、進入不可地点にいる時の挙動、ワンルームから出される処理、他所の私室に入る処理を改良
遭遇判定をまるっと整理
　@RANDOM_ODEKAKEを作成
　余計な処理が無くなりました。実際の挙動は大して変わってません
システムメニューにキャラの出現場所一覧を追加
　キャラの挙動メモ.txtをゲーム内で出力してる感じです
　これでいちいち更新しなくて済む
私室設定の表示を修正＆改良
守矢くじの強制デートによるエラー落ちを応急処置
デート終了時にデート相手が消えるバグを修正

各拠点にある空き部屋や空き小屋等は一部を除いて入居者がいないと進入不可に
後戸組は来訪時、MASTERの背中から出現するように（可能なら）
三月精の家→三妖精の家に再度変更
　こっちのが正しかったですね
神社・寺マップに引っ越した際ROOMSETTINGがおかしかったのを修正
神社マップ時、紫、早苗、神奈子、諏訪子の出現位置を設定
神社、紅魔館、竹林のROOMSETTINGを少し修正
人里マップの関数を再整理
寺、竹林の移動エラーを修正

口上側で引力設定ができるように
ドレミー口上の生活時間を変更する処理をCFLAG:生活時間補正に
　従来はUPDATE等でリセットされてしまっていたのが修正されます
　ただし既に変更済みで[もう変更しない]にしてると変更できませんのでご注意
典口上Ver0.05の引力設定を口上側に移行
典口上Ver0.05のデイリー訓練とお酒をふるまうの成否判定を修正

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.2
1.1で入れ忘れたファイルを同梱
　「出会った時と睡眠時の判定を見えてる範囲から同室のみに」の箇所と、「天の声を聞く」の箇所
修正パッチのCFLAGを同梱
PRIVATEROOMが設定できていなかったのを修正
戦闘訓練ができなかったのを修正
汚部屋察知の色表示が実際の汚れ値と違っていたのを修正
デートに誘われた時、到着までの時間がおかしかったのを修正
カラーマップ＋動画設定時、散策コマンドがおかしくなるのを修正

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
1.1
TW尤魔リソースのキャラデータを取り込み
尤魔に[小柄体型][貧乳]を追加
天の声設定を修正
　祭壇および天界でも可能に
外のお風呂の設定を修正
　@BATHROOMは拠点内の判定のみだった
汚部屋察知の色を調整
　緑→クリームに
出会った時と睡眠時の判定を見えてる範囲から同室のみに


＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
■概要
このパッチは大きく分けて4つの内容があります。
１．尤魔の実装
２．マップの改変
３．散策（出掛ける）の仕様変更
４．ファイル・関数の整理
＋その他

実プレイに影響するのは１、２くらいです。
４は開発者向け。
全体的に内部の細かい処理が変わってるだけなので、大掛かりな割に感じられる変化は少ないかと思われます。

・追記
未だキャラデータの再設定ができてないので、キャラの挙動が適当だったりしますが、後日やります。

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
１．尤魔の実装

画像はありません

自室は冥界の尤魔の部屋
自宅位置は畜生界

八千慧、早鬼に相性追加
_Renameを設定

衣装にスプーンを追加
贈り物形容詞に「強欲な」「剛欲な」を追加

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
２．マップの改変

※カラーマップには対応していません
　カラーマップだと追加された場所がマップ上に表示されません
　カラーマップだと削除された場所がマップ上に表示されます（選択できません）
　マップからではなく選択肢や直接入力で飛ぶことは出来ます

クラシックマップもほぼ全て着色してだいぶ賑やかになりました

以下、各拠点ごとの変更点
●神社
変更：三妖精の家→三月精の家
削除：三月精の家・入口、三月精の家・階段、夢幻遺跡・階段
追加：56,あうんの棲家
あうんの自室をあうんの棲家に

夢幻遺跡の洗面所部分の構造がちょっと変わりました
三月精の家は向きが変わり、入口と階段が無くなったのでもたつきにくくなりました

●寺
変更：経堂→経蔵、客間→女苑私室、梵鐘堂→鐘楼、屠自古部屋→屠自古私室
追加：135,廊下、136,響子私室、137,マミゾウの棲家、138,鐘楼、139,邪仙楼、140,お地蔵通り
・おでかけマップ
変更：140,命蓮寺本堂→140,命蓮寺方丈
変更＆追加：160,聖徳道場→160,神霊廟広場＆170,神霊廟道場
響子の自室を響子私室に、自宅を命蓮寺方丈に
マミゾウの自室をマミゾウの棲家に
芳香、青娥の自室を邪仙楼に、自宅を神霊廟広場に
神子、屠自古、布都の自宅を神霊廟道場に

全体的に大きく変わりました。多分一番変更が大きいです
地蔵通りを共通の参道として追加
・命蓮寺
響子、マミゾウ、女苑用に部屋を設定（客間は乗っ取られました）
本堂を正面に据える基本的なお寺スタイルに
正面の配置は深秘録を参考に
方丈を拡張して響子の私室も追加
廊下もできました
部屋の間取りも変わってます
・神霊廟
聖天宮をモデルに鐘楼を設定
片方は青娥と芳香の部屋にしました
他は道場が入口になる構造がちょっと変わったくらい

●里
変更：あなたの部屋→空き部屋
ほぼ変わってませんが、長屋内は付喪神組、ユキマイ、蓮メリ間でのみ接続するように

●湖
削除：大階段、地下階段、三階階段、廃洋館・階段
クラシックマップの方は紅魔館一階＆地下と二階＆三階でページ分けしました
おかげで各部屋が広くなりました
階段が無くなったので引っかかりにくくなりました
廃洋館は向きが変わりました
湖マップはボリュームアップ

●竹林
廃屋を住み込み部屋として使えるように

●森
変更：エレン宅・エレン私室→エレン宅・寝室、成美の家→成美の小屋
ルーミア、成美の自宅を古木の大樹に
クラシックマップはやや縮小
魔理沙宅、エレン宅をやや拡張
地点の接続が変だったのを修正

●冥界
変更：あなた私室→空室
追加：653,尤魔宅のリビング、654,尤魔宅の寝室、655,尤魔宅の風呂
畜生界に尤魔の部屋を設定

●山麓
変更：地下間欠泉センター→間欠泉地下センター
追加：737,招き猫の家、738,森の深奥、739,秘天崖、740,山童のアジト
・おでかけマップ
追加：770,森の深奥
ネムノの自宅を森の深奥に
ミケの自室を招き猫の家、自宅を麓の樹海に
たかねの自室を山童のアジト、自宅を森の深奥に
地点の接続が変だったのを修正

●山頂
追加：851,久侘歌の小屋、852,駒草の小屋、853,魅須丸の小屋、
　　　854,龍宅、855,虹龍洞、856,百々世の住処
・おでかけマップ
追加：860,虹龍洞
久侘歌の自室を久侘歌の小屋に
駒草の自室を駒草の小屋に、自宅を絶景の丘に
魅須丸の自室を魅須丸の小屋に、自宅を絶景の丘に
典、龍の自室を龍の小屋に、自宅を絶景の丘に
百々世の自室を百々世の住処、自宅を虹龍洞に

山頂部分が拡張されました
守矢神社の土間周辺もリフォーム

●地底
削除：エントランス、応接間
変更：地底都市最深部→地獄の人工太陽、地獄の人工太陽→旧血の池地獄
空き屋を住み込み部屋として使えるように
クラシックマップは全体的に少しずつ改変してます
エントランスと応接間が無くなったので引っかかりにくいです
旧地獄部分は剛欲異聞風

●月
変更：半角スペースを中黒に（サグメ宅 居間→サグメ宅・居間）
ほぼ変わってません

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
３．散策（出掛ける）の仕様変更
●デート道中
道中の場所IDはMAPID×100＋97で固定（場所ID＝ROAD_TO(MAPID)）
道中の残り時間をTFLAG:デート道中に設定
これによって100分以上の地域にも道中デートできるように
道中の判別もTFLAG:デート道中だけでオッケー
従来の複雑な処理は全て整理しました

●散策（おでかけマップ）
今まで一次元だったおでかけマップが二次元になりました
これによっておでかけマップの自由度も上がり、移動時間も違和感が無くなりました
クラシックマップは全て一新されてます

○その他
散策時の時間停止移動が有効だと自動でTSP消費になります

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
４．ファイル・関数の整理
物件関連を中心にファイルを見直して関数を整理
主に必要無くなった関数の削除、散らかってた関数の場所（ファイル）を整理、処理のスリム化

PLACE.ERHを新設して、全ての場所ID、MAPIDをDIMで設定
おでかけマップもDIM.ERHの方で全て設定（神社だけ無かったやつ）
逆に神社だけあった場所IDのDIMを削除
将来への布石としてMAXHOMEも設定

以下、主な変更点
−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
◎以下の口上は関数や変数が変わったので修正を加えました（フラン、こいし、こころは修正パッチの方）
魔理沙、はたて、る〜こと、アリス、エレン、クラウンピース、
サニーミルク、スターサファイア、ドレミー、ルナサ、ルナチャイルド、影狼、映姫、藍

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
・COLOREDMAPS関連
マップの関数名を変更（00,03,04）
DRAW_COLOREDMAPを新しい仕様に対応
CALLFORM MAP_VIEWING_{MAIN_MAP}を共通の処理で統合

・GETMAP_X.ERB、PLACE_X.ERB
大部分が必要無くなったので全削除。残った部分をMAP_COMM_X.ERBに統合

・MOB.ERB
各所に散らばっていたモブ関数を一纏めに

・PLACE_拠点共通.ERB
多くの処理をROOMDATAと@ODEKAKEMAP_SETTINGを参照するだけでできるように

・出掛け先への所要時間.ERB
散策に使われている小町、わかさぎ姫、神子の特殊効果と各所ショートカット効果を統合
ショートカット効果はMAPIDを入れるだけで判別できるように

・DRAW_MAP.ERB
マップ描画関連の関数を一纏めに
カラーマップの共通処理を統合

・JOB_仕事内容.ERB
職場設定の見直し
共通の仕事の設定を関数化

・SHOP_住環境設定.ERB
・BEFORETRAIN.ERB
神社専用の処理が必要なくなったので削除

・DAIRY_EV2..ERB（DAILY_CONDITION_EV2）
AREANAME_CHARA_HOMEをMAP_AREASELECTに

・各種キャラデータ
ネムノ、ミケ、たかね、駒草、魅須丸、典、龍、百々世、リリーＷ＆Ｂ、橙、神子、椛、秋姉妹、青娥、屠自古、布都
出現位置に新規地点を追加

−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
@DRAW_MAP_BG_X
ややテンプレ化
菜園や矢印等は共通の処理を設定
色を共有できるようにDIM COLORにMAP用のものを追加

@MAP_PLACENAME_X
テンプレ化
MAXROOMの名称はここで設定するように
MASTERの自室にあたる空き部屋や空き小屋の名称もここで設定
住み込み部屋も同様

@MAP_AREASELECT_X
旧@MAP_VIEWING_Xは関数内でTFLAGを変えていたため一新
#FUNCTIONにしてエリア関数としても使えるように

@GETMAP_BUILDING
拠点ごとに設定できるようにし、表示しているマップで判定を変えたり機能を拡張

@CAN_MOVE_X
地点の接続を再設定

@ROOMSETTING_X
削除：青天井、見通し、狭い、うたた寝_可能、うたた寝_常時可
変更：居間→飲食
追加：屋根、洋室、つまみ食い
ほぼ使われてなかった広いを起用
青天井は屋内、屋根が無いことで判定
見通しは広い、狭いはnot広いで判定
属性ごとに地点を設定していたのを、地点ごとに属性を設定するように
割とどこもガバガバ設定だったのでよく見直して細かく再設定
特に月見やプライベートの使い方を明文化

@ODEKAKEMAP_SETTING_X
おでかけマップも引数から属性を設定できるように
散策時の座標や特殊ワープにも使ってます

@SKIP_MOVE_X
全部見直して再設定
そのせいでバグ出るかも…
エリアから出るときの処理はバグるだけなのでやめました

@MAP_DEFAULTRESIDENT
UPDATEで読み込まれるようにして新規の住民を設定できるように

@ROOMSETTING
MASTERの私室、洋室、厨房も新たに補完するように
私室が変わったキャラなどの為に施錠をリセットするように

@TURN_RESET
デート道中の処理を追加

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
○その他
移動および察知のレイアウトをやや改良（関数もスリム化）
遠距離移動して直前位置に戻される処理がおかしかったのを修正
移動時間が1地点ごとに+3分だったのが+2分に
汚部屋察知に清潔度：高を設定

拠点の外で待機しているキャラが動きやすくなるように
移動節度に関係なく過疎地点は過疎るように
一応自室施錠を設定（処理はあるがフラグを立てる手段は無い）

早鬼、明羅、里香のキャラデータにミスがあったのを修正

@COLORMESSAGEにPRINTPLAINを追加

@ENDUFUFUにTOUCH_SETを追加
